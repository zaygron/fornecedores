@page "/admin/solicitar-cadastro"
@using Falcare.Cadastro.Core.Interfaces
@inject IFornecedorService FornecedorService
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<MudText Typo="Typo.h4" GutterBottom="true">Solicitar Cadastro de Fornecedor</MudText>

<MudPaper Class="pa-4" MaxWidth="600px">
    <MudForm @ref="form" @bind-IsValid="@success">
        <MudTextField T="string" Label="CNPJ" @bind-Value="cnpj" Required="true" RequiredError="CNPJ é obrigatório" Mask="@(new PatternMask("00.000.000/0000-00"))" />
        <MudTextField T="string" Label="Nome da Empresa" @bind-Value="nomeEmpresa" Required="true" RequiredError="Nome é obrigatório" />
        <MudTextField T="string" Label="E-mail de Contato" @bind-Value="email" Required="true" RequiredError="E-mail é obrigatório" InputType="InputType.Email" />
        
        <MudButton Variant="Variant.Filled" Color="Color.Primary" DisableElevation="true" Class="mt-4" OnClick="Solicitar" Disabled="isLoading">
            @if (isLoading)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                <MudText Class="ms-2">Enviando...</MudText>
            }
            else
            {
                <MudText>Solicitar Cadastro</MudText>
            }
        </MudButton>
    </MudForm>
</MudPaper>

<MudAlert Severity="Severity.Info" Class="mt-4">
    <MudText>
        Um e-mail com o link de definição de senha será enviado para o endereço informado.
        O fornecedor poderá acessar o link e criar sua senha para acessar o sistema.
    </MudText>
</MudAlert>

@code {
    MudForm form = default!;
    bool success;
    bool isLoading = false;
    string cnpj = string.Empty;
    string nomeEmpresa = string.Empty;
    string email = string.Empty;

    private async Task Solicitar()
    {
        try
        {
            await form.Validate();
            if(!form.IsValid) return;

            isLoading = true;

            var fornecedor = await FornecedorService.CreateDraftAsync(nomeEmpresa, cnpj, email);
            var inviteLink = await FornecedorService.SendInvitationAsync(fornecedor.Id);
            
            Snackbar.Add($"Convite enviado com sucesso para {email}!", Severity.Success);
            
            // Clear form
            cnpj = "";
            nomeEmpresa = "";
            email = "";
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao solicitar: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }
}
