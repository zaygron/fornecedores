@page "/fornecedor/dashboard"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Falcare.Cadastro.Core.Entities
@using Falcare.Cadastro.Core.Interfaces
@using Falcare.Cadastro.Core.Enums
@using MudBlazor
@attribute [Authorize]
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IFornecedorService FornecedorService
@inject IFuncionarioService FuncionarioService
@inject NavigationManager Navigation
@rendermode InteractiveServer

    <MudGrid>
        @if (fornecedor == null)
        {
             <MudItem xs="12">
                 <MudAlert Severity="Severity.Warning" Variant="Variant.Filled">
                     Seu cadastro de empresa ainda não foi realizado. <MudLink Href="/fornecedor/dados-empresa" Color="Color.Inherit">Clique aqui para preencher.</MudLink>
                 </MudAlert>
             </MudItem>
        }
        else
        {
             <MudItem xs="12" sm="4">
                <MudPaper Class="pa-6 d-flex flex-column align-center justify-center rounded-lg" Elevation="4" Style="height: 200px;">
                    <MudAvatar Color="Color.Primary" Size="Size.Large" Variant="Variant.Filled" Class="mb-3">
                         <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Medium" />
                    </MudAvatar>
                    <MudText Typo="Typo.h6">@fornecedor.NomeEmpresa</MudText>
                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(fornecedor.Status)" Class="my-1">@fornecedor.Status</MudChip>
                    <MudText Typo="Typo.caption" Class="mb-2">@fornecedor.CNPJ</MudText>
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" Href="/fornecedor/dados-empresa">Ver Dados</MudButton>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="4">
                <MudPaper Class="pa-6 d-flex flex-column align-center justify-center rounded-lg" Elevation="4" Style="height: 200px;">
                    <MudAvatar Color="Color.Secondary" Size="Size.Large" Variant="Variant.Filled" Class="mb-3">
                         <MudIcon Icon="@Icons.Material.Filled.Group" Size="Size.Medium" />
                    </MudAvatar>
                     <MudText Typo="Typo.h4" Color="Color.Secondary"><b>@funcionariosCount</b></MudText>
                    <MudText Typo="Typo.body2">Funcionários</MudText>
                    <MudButton Variant="Variant.Text" Color="Color.Secondary" Size="Size.Small" Href="/fornecedor/funcionarios" Class="mt-1">Gerenciar</MudButton>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="4">
                 <MudPaper Class="pa-6 d-flex flex-column align-center justify-center rounded-lg" Elevation="4" Style="height: 200px;">
                    <MudAvatar Color="Color.Info" Size="Size.Large" Variant="Variant.Filled" Class="mb-3">
                         <MudIcon Icon="@Icons.Material.Filled.FolderOpen" Size="Size.Medium" />
                    </MudAvatar>
                    <MudText Typo="Typo.h6">Documentos</MudText>
                    <MudText Typo="Typo.caption" Class="mb-3">Gestão de Anexos</MudText>
                    <MudButton Variant="Variant.Outlined" Color="Color.Info" Size="Size.Small" Href="/fornecedor/funcionarios">Verificar</MudButton>
                </MudPaper>
            </MudItem>
        }
    </MudGrid>

@code {
    private bool loading = true;
    private Fornecedor? fornecedor;
    private int funcionariosCount = 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

            if (!string.IsNullOrEmpty(userId))
            {
                fornecedor = await FornecedorService.GetByUserIdAsync(userId);
                if (fornecedor != null)
                {
                    var funcionarios = await FuncionarioService.GetByFornecedorIdAsync(fornecedor.Id);
                    funcionariosCount = funcionarios.Count;
                }
            }
        }
        finally
        {
            loading = false;
        }
    }
    private Color GetStatusColor(StatusFornecedor status)
    {
         return status switch
        {
            StatusFornecedor.Pendente => Color.Warning,
            StatusFornecedor.EmAnalise => Color.Info,
            StatusFornecedor.Aprovado => Color.Success,
            StatusFornecedor.Reprovado => Color.Error,
            StatusFornecedor.Bloqueado => Color.Dark,
            _ => Color.Default
        };
    }
}
