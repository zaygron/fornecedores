@page "/fornecedor/funcionarios/novo"
@page "/fornecedor/funcionarios/editar/{Id:int}"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using System.Security.Claims
@using Falcare.Cadastro.Core.Entities
@using Falcare.Cadastro.Core.Interfaces
@using Falcare.Cadastro.Core.Enums
@using MudBlazor
@attribute [Authorize]
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IFornecedorService FornecedorService
@inject IFuncionarioService FuncionarioService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4 mb-8">
    <MudPaper Elevation="0" Class="pa-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
            <MudText Typo="Typo.h5" Color="Color.Primary">
                <MudIcon Icon="@(Id == 0 ? Icons.Material.Filled.PersonAdd : Icons.Material.Filled.Edit)" Class="mr-2" />
                @(Id == 0 ? "Novo Funcionário" : "Editar Funcionário")
            </MudText>
            <MudButton Variant="Variant.Text" 
                       StartIcon="@Icons.Material.Filled.ArrowBack"
                       Href="/fornecedor/funcionarios">
                Voltar
            </MudButton>
        </MudStack>

        <EditForm Model="model" OnValidSubmit="Submit">
            <DataAnnotationsValidator />
            
            <!-- Seção: Informações de Cadastro -->
            <MudCard Elevation="2" Class="mb-3">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.subtitle1">
                            <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
                            Informações de Cadastro
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent Class="py-2">
                    <MudGrid Spacing="2">
                        <MudItem xs="12" md="6">
                            <MudSelect T="string" 
                                       @bind-Value="propositoCadastro" 
                                       Label="Propósito do Cadastro" 
                                       Variant="Variant.Outlined"
                                       AdornmentIcon="@Icons.Material.Filled.Assignment"
                                       Adornment="Adornment.Start">
                                <MudSelectItem T="string" Value="@("")">-- Selecione --</MudSelectItem>
                                <MudSelectItem T="string" Value="@("Integração")">Integração</MudSelectItem>
                                <MudSelectItem T="string" Value="@("Outros")">Outros</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudSelect T="NaturezaAtividade" 
                                       @bind-Value="model.NaturezaAtividade" 
                                       Label="Natureza das Atividades" 
                                       Variant="Variant.Outlined"
                                       AdornmentIcon="@Icons.Material.Filled.Work"
                                       Adornment="Adornment.Start">
                                <MudSelectItem T="NaturezaAtividade" Value="NaturezaAtividade.Administrativo">Serviços Administrativos em Área de Escritório</MudSelectItem>
                                <MudSelectItem T="NaturezaAtividade" Value="NaturezaAtividade.FabricaOficina">Serviços na Fábrica / Oficina</MudSelectItem>
                                <MudSelectItem T="NaturezaAtividade" Value="NaturezaAtividade.Outros">Outros</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        @if (model.NaturezaAtividade == NaturezaAtividade.Outros)
                        {
                            <MudItem xs="12">
                                <MudTextField T="string" 
                                              @bind-Value="model.OutraNaturezaDescricao" 
                                              Label="Descreva Outras Atividades" 
                                              Variant="Variant.Outlined"
                                              Lines="3"
                                              Placeholder="Descreva as atividades..." />
                            </MudItem>
                        }
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            <!-- Seção: Responsável Legal -->
            <MudCard Elevation="2" Class="mb-3">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.subtitle1">
                            <MudIcon Icon="@Icons.Material.Filled.AccountCircle" Class="mr-2" />
                            Responsável Legal
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent Class="py-2">
                    <MudGrid Spacing="2">
                        <MudItem xs="12" md="6">
                            <MudTextField T="string" 
                                          @bind-Value="model.NomeResponsavelLegal" 
                                          Label="Nome do Responsável Legal" 
                                          Variant="Variant.Outlined"
                                          Required="true"
                                          AdornmentIcon="@Icons.Material.Filled.Person"
                                          Adornment="Adornment.Start" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField T="string" 
                                          @bind-Value="model.EmailResponsavel" 
                                          Label="E-mail do Responsável" 
                                          Variant="Variant.Outlined"
                                          Required="true"
                                          InputType="InputType.Email"
                                          AdornmentIcon="@Icons.Material.Filled.Email"
                                          Adornment="Adornment.Start" />
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            <!-- Seção: Dados Pessoais -->
            <MudCard Elevation="2" Class="mb-3">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.subtitle1">
                            <MudIcon Icon="@Icons.Material.Filled.Badge" Class="mr-2" />
                            Dados Pessoais do Funcionário
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent Class="py-2">
                    <MudGrid Spacing="2">
                        <MudItem xs="12" md="6">
                            <MudTextField T="string" 
                                          @bind-Value="model.Nome" 
                                          Label="Nome Completo" 
                                          Variant="Variant.Outlined"
                                          Required="true"
                                          AdornmentIcon="@Icons.Material.Filled.Person"
                                          Adornment="Adornment.Start" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField T="string" 
                                          @bind-Value="model.Cargo" 
                                          Label="Cargo/Função" 
                                          Variant="Variant.Outlined"
                                          Required="true"
                                          AdornmentIcon="@Icons.Material.Filled.Work"
                                          Adornment="Adornment.Start" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField T="string" 
                                          @bind-Value="dataNascimentoStr" 
                                          Label="Data de Nascimento" 
                                          Variant="Variant.Outlined"
                                          AdornmentIcon="@Icons.Material.Filled.Cake"
                                          Adornment="Adornment.Start"
                                          Mask="@(new DateMask("dd/MM/yyyy"))"
                                          Placeholder="dd/MM/yyyy" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudSwitch T="bool" 
                                       @bind-Value="model.Ativo" 
                                       Label="Funcionário Ativo" 
                                       Color="Color.Success" />
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            <!-- Seção: Documentos de Identificação -->
            <MudCard Elevation="2" Class="mb-3">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.subtitle1">
                            <MudIcon Icon="@Icons.Material.Filled.Description" Class="mr-2" />
                            Documentos de Identificação
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent Class="py-2">
                    <MudGrid Spacing="2">
                        <MudItem xs="12" md="6">
                            <MudTextField T="string" 
                                          @bind-Value="model.CTPS_NumeroSerie" 
                                          Label="Carteira de Trabalho (CTPS)" 
                                          Variant="Variant.Outlined"
                                          Placeholder="Ex: 123456789 / 001"
                                          AdornmentIcon="@Icons.Material.Filled.CardMembership"
                                          Adornment="Adornment.Start" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField T="string" 
                                          @bind-Value="model.RG" 
                                          Label="RG" 
                                          Variant="Variant.Outlined"
                                          Placeholder="Ex: 12.345.678-9"
                                          AdornmentIcon="@Icons.Material.Filled.CreditCard"
                                          Adornment="Adornment.Start" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField T="string" 
                                          @bind-Value="rgVencimentoStr" 
                                          Label="Data de Vencimento do RG" 
                                          Variant="Variant.Outlined"
                                          AdornmentIcon="@Icons.Material.Filled.CalendarToday"
                                          Adornment="Adornment.Start"
                                          Mask="@(new DateMask("dd/MM/yyyy"))"
                                          Placeholder="dd/MM/yyyy" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField T="string" 
                                          @bind-Value="model.CPF" 
                                          Label="CPF" 
                                          Variant="Variant.Outlined"
                                          Required="true"
                                          Placeholder="000.000.000-00"
                                          AdornmentIcon="@Icons.Material.Filled.Fingerprint"
                                          Adornment="Adornment.Start" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField T="string" 
                                          @bind-Value="cpfVencimentoStr" 
                                          Label="Data de Vencimento do CPF" 
                                          Variant="Variant.Outlined"
                                          AdornmentIcon="@Icons.Material.Filled.CalendarToday"
                                          Adornment="Adornment.Start"
                                          Mask="@(new DateMask("dd/MM/yyyy"))"
                                          Placeholder="dd/MM/yyyy" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField T="string" 
                                          @bind-Value="model.CNH" 
                                          Label="CNH - Número" 
                                          Variant="Variant.Outlined"
                                          Placeholder="Ex: 12345678901"
                                          AdornmentIcon="@Icons.Material.Filled.DriveEta"
                                          Adornment="Adornment.Start" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField T="string" 
                                          @bind-Value="cnhVencimentoStr" 
                                          Label="Data de Vencimento da CNH" 
                                          Variant="Variant.Outlined"
                                          AdornmentIcon="@Icons.Material.Filled.CalendarToday"
                                          Adornment="Adornment.Start"
                                          Mask="@(new DateMask("dd/MM/yyyy"))"
                                          Placeholder="dd/MM/yyyy" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField T="string" 
                                          @bind-Value="asoVencimentoStr" 
                                          Label="Data de Vencimento do ASO" 
                                          Variant="Variant.Outlined"
                                          AdornmentIcon="@Icons.Material.Filled.HealthAndSafety"
                                          Adornment="Adornment.Start"
                                          Mask="@(new DateMask("dd/MM/yyyy"))"
                                          Placeholder="dd/MM/yyyy" />
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            <!-- Seção: Conformidade e Segurança do Trabalho -->
            <MudCard Elevation="2" Class="mb-3">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.subtitle1">
                            <MudIcon Icon="@Icons.Material.Filled.Security" Class="mr-2" />
                            Conformidade e Segurança do Trabalho
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent Class="py-2">
                    <MudStack Spacing="4">
                        <div>
                            <MudSwitch T="bool" 
                                       @bind-Value="model.TrabalhaComEletricidade" 
                                       Label="Trabalhará com eletricidade?" 
                                       Color="Color.Warning" />
                            @if (model.TrabalhaComEletricidade)
                            {
                                <MudAlert Severity="Severity.Warning" Class="mt-2">
                                    <MudText Typo="Typo.body2">
                                        <strong>⚠️ Atenção:</strong> Anexar documentos que comprovem. Além da indicação no ASO para trabalho com eletricidade.
                                    </MudText>
                                </MudAlert>
                            }
                        </div>

                        <div>
                            <MudSwitch T="bool" 
                                       @bind-Value="model.MovimentacaoCarga" 
                                       Label="Serviços com equipamentos de movimentação de cargas (NR11)?" 
                                       Color="Color.Warning" />
                            @if (model.MovimentacaoCarga)
                            {
                                <MudAlert Severity="Severity.Warning" Class="mt-2">
                                    <MudText Typo="Typo.body2">
                                        <strong>⚠️ Atenção:</strong> Solicitar anexar certificado de treinamento em NR11 conforme equipamento/veículo a ser operado.
                                    </MudText>
                                </MudAlert>
                            }
                        </div>

                        <div>
                            <MudSwitch T="bool" 
                                       @bind-Value="model.CaldeirasVasosPressao" 
                                       Label="Serviços envolvendo caldeiras ou vasos de pressão (NR13)?" 
                                       Color="Color.Warning" />
                            @if (model.CaldeirasVasosPressao)
                            {
                                <MudAlert Severity="Severity.Warning" Class="mt-2">
                                    <MudText Typo="Typo.body2">
                                        <strong>⚠️ Atenção:</strong> Anexar certificado de treinamento de segurança de operação de caldeiras e comprovante de estágio prático ou experiência na função.
                                    </MudText>
                                </MudAlert>
                            }
                        </div>

                        <div>
                            <MudSwitch T="bool" 
                                       @bind-Value="model.TrabalhoAltura" 
                                       Label="Serviços com trabalho em altura (NR35)?" 
                                       Color="Color.Warning" />
                            @if (model.TrabalhoAltura)
                            {
                                <MudAlert Severity="Severity.Warning" Class="mt-2">
                                    <MudText Typo="Typo.body2">
                                        <strong>⚠️ Atenção:</strong> Anexar:<br/>
                                        1 - Certificado de conclusão de curso específico na área elétrica reconhecido pelo sistema oficial de ensino<br/>
                                        2 - Certificado de treinamento NR 10 de acordo com a norma regulamentadora<br/>
                                        3 - Certificado de treinamento SEP (Alta tensão)
                                    </MudText>
                                </MudAlert>
                            }
                        </div>
                    </MudStack>
                </MudCardContent>
            </MudCard>

            <!-- Botões de Ação -->
            <MudPaper Elevation="0" Class="d-flex justify-end gap-2 pa-4">
                <MudButton Variant="Variant.Outlined" 
                           StartIcon="@Icons.Material.Filled.Cancel"
                           OnClick="Cancel">
                    Cancelar
                </MudButton>
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Save"
                           ButtonType="ButtonType.Submit">
                    Salvar
                </MudButton>
            </MudPaper>
        </EditForm>
    </MudPaper>
</MudContainer>

@code {
    [Parameter] public int Id { get; set; }

    private Funcionario model = new();
    private string dataNascimentoStr = string.Empty;
    private string rgVencimentoStr = string.Empty;
    private string cpfVencimentoStr = string.Empty;
    private string cnhVencimentoStr = string.Empty;
    private string asoVencimentoStr = string.Empty;
    private Fornecedor? fornecedor;
    private string propositoCadastro = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity != null && user.Identity.IsAuthenticated)
            {
                var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
                if (!string.IsNullOrEmpty(userId))
                {
                    fornecedor = await FornecedorService.GetByUserIdAsync(userId);
                }
            }

            if (Id != 0)
            {
                var existing = await FuncionarioService.GetByIdAsync(Id);
                if (existing != null)
                {
                    if (fornecedor != null && existing.FornecedorId == fornecedor.Id)
                    {
                        model = existing;
                        propositoCadastro = model.PropositoCadastro ?? string.Empty;
                        dataNascimentoStr = model.DataNascimento?.ToString("dd/MM/yyyy") ?? string.Empty;
                        rgVencimentoStr = model.RG_DataVencimento?.ToString("dd/MM/yyyy") ?? string.Empty;
                        cpfVencimentoStr = model.CPF_DataVencimento?.ToString("dd/MM/yyyy") ?? string.Empty;
                        cnhVencimentoStr = model.CNH_DataVencimento?.ToString("dd/MM/yyyy") ?? string.Empty;
                        asoVencimentoStr = model.ASO_DataVencimento?.ToString("dd/MM/yyyy") ?? string.Empty;
                    }
                    else
                    {
                        Navigation.NavigateTo("/fornecedor/funcionarios");
                    }
                }
            }
            else if (fornecedor != null)
            {
                model = new Funcionario { FornecedorId = fornecedor.Id, Ativo = true };
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao inicializar: {ex.Message}", Severity.Error);
            Console.WriteLine($"Erro ao inicializar: {ex.Message}");
        }
    }

    private async Task Submit()
    {
        try
        {
            model.PropositoCadastro = propositoCadastro;
            model.DataNascimento = ParseDateString(dataNascimentoStr);
            model.RG_DataVencimento = ParseDateString(rgVencimentoStr);
            model.CPF_DataVencimento = ParseDateString(cpfVencimentoStr);
            model.CNH_DataVencimento = ParseDateString(cnhVencimentoStr);
            model.ASO_DataVencimento = ParseDateString(asoVencimentoStr);

            if (model.Id == 0)
            {
                await FuncionarioService.AddAsync(model);
                Snackbar.Add("Funcionário cadastrado com sucesso!", Severity.Success);
            }
            else
            {
                await FuncionarioService.UpdateAsync(model);
                Snackbar.Add("Funcionário atualizado com sucesso!", Severity.Success);
            }
            Navigation.NavigateTo("/fornecedor/funcionarios");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao salvar: {ex.Message}", Severity.Error);
            Console.WriteLine($"Erro ao salvar: {ex.Message}");
        }
    }

    private DateTime? ParseDateString(string dateStr)
    {
        if (string.IsNullOrWhiteSpace(dateStr))
            return null;

        if (DateTime.TryParseExact(dateStr, "dd/MM/yyyy", 
            System.Globalization.CultureInfo.InvariantCulture, 
            System.Globalization.DateTimeStyles.None, 
            out DateTime result))
        {
            return DateTime.SpecifyKind(result, DateTimeKind.Utc);
        }

        return null;
    }

    private void Cancel() => Navigation.NavigateTo("/fornecedor/funcionarios");
}
